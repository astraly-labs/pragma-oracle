name: Compare Snapshot

on: pull_request

permissions:
  pull-requests: write

jobs:
  compare_snapshot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.x"

      - name: Run compare_snapshot script
        id: run_script
        run: |
          result=$(python scripts/gas_usage/compare_snapshot.py)
          # Use base64 to safely encode multi-line string
          echo "output=$(echo -n "$result" | base64)" >> $GITHUB_ENV
    outputs: 
      output: ${{ steps.run_script.outputs.output }}

  display_result:
    needs: compare_snapshot
    runs-on: ubuntu-latest
    steps:
      - name: Decode and display output
        run: |
          # Decode the base64 encoded result
          result=$(echo -n "${{ needs.compare_snapshot.outputs.output }}" | base64 --decode)
          # Replace encoded characters with their original forms
          result=$(echo -n "$result" | sed 's/%0A/\n/g; s/%25/%/g')
          echo "$result"

      - name: Comment on PR
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          result=$(echo -n "${{ needs.compare_snapshot.outputs.output }}" | base64 --decode)
          result=$(echo -n "$result" | sed 's/%0A/\n/g; s/%25/%/g')
          comment="Output from Compare Snapshot:\n\`\`\`\n$result\n\`\`\`"
          pr_number=$(jq -r ".number" "$GITHUB_EVENT_PATH")
          repo_full_name=$(jq -r ".repository.full_name" "$GITHUB_EVENT_PATH")
          
          curl \
            -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/$repo_full_name/issues/$pr_number/comments \
            -d "{\"body\":\"$comment\"}"
