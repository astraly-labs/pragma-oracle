name: Compare Snapshot

on: pull_request

permissions:
  pull-requests: write

jobs:
  compare_snapshot:
    permissions: write-all
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.x"

      - name: Set up Scarb
        uses: software-mansion/setup-scarb@v1

      - name: Run compare_snapshot script
        id: run_script
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          result=$(python scripts/gas_usage/compare_snapshot.py)
          encoded_result=$(echo -n "$result" | base64)
          echo "output=$encoded_result" >> $GITHUB_OUTPUT
    outputs:
      output: ${{ steps.run_script.outputs.output }}

  display_result:
    needs: compare_snapshot
    runs-on: ubuntu-latest
    steps:
      - name: Decode and Display Output
        run: |
          encoded_output="${{ needs.compare_snapshot.outputs.output }}"
          decoded_output=$(echo -n "$encoded_output" | base64 --decode)
          echo "$decoded_output"

      - name: Comment on PR
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          encoded_output="${{ needs.compare_snapshot.outputs.output }}"
          decoded_output=$(echo -n "$encoded_output" | base64 --decode)
          comment="Output from Compare Snapshot:\n\`\`\`\n$decoded_output\n\`\`\`"
          pr_number=$(jq -r ".number" "$GITHUB_EVENT_PATH")
          repo_full_name=$(jq -r ".repository.full_name" "$GITHUB_EVENT_PATH")

          curl \
            -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/$repo_full_name/issues/$pr_number/comments \
            -d "{\"body\":\"$comment\"}"
